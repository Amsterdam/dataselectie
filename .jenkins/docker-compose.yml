elasticsearch:
    image: build.datapunt.amsterdam.nl:5000/atlas/elasticsearch:latest
    volumes:
      - ./backups/elasticsearch:/tmp/backups
    user: root
    command: /usr/share/elasticsearch/bin/elasticsearch -Des.insecure.allow.root=true -Des.network.host=0.0.0.0 -Des.path.repo=/tmp


database_dataselectie:
    image: build.datapunt.amsterdam.nl:5000/atlas/postgres
    environment:
        POSTGRES_USER: dataselectie
        POSTGRES_DB: dataselectie
        POSTGRES_PASSWORD: insecure

database_BAG:
    image: build.datapunt.amsterdam.nl:5000/atlas/postgres
    environment:
        POSTGRES_USER: atlas
        POSTGRES_DB: atlas
        POSTGRES_PASSWORD: insecure

database_HR:
    image: build.datapunt.amsterdam.nl:5000/atlas/postgres
    environment:
        POSTGRES_USER: handelsregister
        POSTGRES_DB: handelsregister
        POSTGRES_PASSWORD: insecure

tests:
  build: ../web
  links:
    - database_dataselectie:database_dataselectie
    - elasticsearch:elasticsearch
    - database_BAG:database_BAG
    - database_HR:database_HR
  environment:
    DATABASE_NAME: dataselectie
    DATABASE_USER: dataselectie
    DATABASE_PASSWORD: insecure
    DJANGO_SETTINGS_MODULE: dataselectie.settings
  command: bash -c "/app/docker-wait.sh && python manage.py migrate && python manage.py test"

importer:
  build: build.datapunt.amsterdam.nl:5000/datapunt/dataselectie:production
  links:
    - elasticsearch:elasticsearch
    - database_dataselectie:database_dataselectie
    - database_BAG:database_BAG
    - database_HR:database_HR
  environment:
    DJANGO_SETTINGS_MODULE: dataselectie.settings
  command: >
    bash -c "/app/docker-wait.sh \
            && python manage.py migrate \
            && python manage.py elastic_indices --recreate"

importer_el1:
  build: build.datapunt.amsterdam.nl:5000/datapunt/dataselectie:production
  links:
    - elasticsearch:elasticsearch
    - database_dataselectie:database_dataselectie
    - database_BAG:database_BAG
    - database_HR:database_HR
  environment:
    DJANGO_SETTINGS_MODULE: dataselectie.settings
  command: >
    bash -c "/app/docker-wait.sh \
            && python manage.py elastic_indices --partial=1/3 --build"

importer_el2:
  build: build.datapunt.amsterdam.nl:5000/datapunt/dataselectie:production
  links:
    - elasticsearch:elasticsearch
    - database_dataselectie:database_dataselectie
    - database_BAG:database_BAG
    - database_HR:database_HR
  environment:
    DJANGO_SETTINGS_MODULE: dataselectie.settings
  command: >
    bash -c "/app/docker-wait.sh \
            && python manage.py elastic_indices --partial=2/3 --build"

importer_el3:
  build: build.datapunt.amsterdam.nl:5000/datapunt/dataselectie:production
  links:
    - elasticsearch:elasticsearch
    - database_dataselectie:database_dataselectie
    - database_BAG:database_BAG
    - database_HR:database_HR
  environment:
    DJANGO_SETTINGS_MODULE: dataselectie.settings
  command: >
    bash -c "/app/docker-wait.sh \
            && python manage.py elastic_indices --partial=3/3 --build"

el-backup:
  image: build.datapunt.amsterdam.nl:5000/atlas/elasticsearch
  links:
    - elasticsearch:el
  volumes:
    - ./backups/elasticsearch:/tmp/backups
  user: root
  command: >
    bash -c "curl -X PUT http://el:9200/_snapshot/backup -d '{ \"type\": \"fs\", \"settings\": { \"location\": \"/tmp/backups\" }}' \
            && curl -X PUT http://el:9200/_snapshot/backup/ds_bag?wait_for_completion=true -d '{ \"indices\": \"ds_bag\" }' \
            && chown -R 997:997 /tmp/backups"
